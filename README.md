# Project Aeon - Template

The Project Aeon template repository contains a workflow demonstrating the fundamental building blocks of an experimental acquisition system using Aeon components. These components are part of the [Project Aeon Platform](https://github.com/SainsburyWellcomeCentre/aeon_experiments), a collection of [Bonsai](https://bonsai-rx.org/) and Python packages designed to support standardized, large-scale, and reproducible experiments. This template provides a full acquisition pipeline, including the specification of a Domain-Specific Language for the task, establishing communication and control over Project Aeon and [Harp](https://github.com/harp-tech) hardware, acquisition and logging of data, and experimental metadata.

Experimental workflows to execute full Project Aeon experiments can be found at the `aeon_experiments` [repository](https://github.com/SainsburyWellcomeCentre/aeon_experiments), and detailed documentation and guidance on Project AEON Habitat construction, data handling and control can be found [here](https://sainsburywellcomecentre.github.io/aeon_docs/).

## Deployment Instructions

The Project Aeon acquisition framework runs on the [Bonsai](https://bonsai-rx.org/) visual programming language. This repository includes installation scripts that automatically download and configure a reproducible, self-contained Bonsai environment to run all acquisition systems in the foraging arena. However, a few system dependencies and device drivers must be installed separately before running the environment configuration script.

### Prerequisites

These should only need to be installed once on a fresh system. They are not required if simply refreshing the installation or deploying to a new folder.

- Windows 10
- [Visual Studio Code](https://code.visualstudio.com/) (recommended for editing scripts and Git commits)
- [.NET Framework 4.7.2 Developer Pack](https://dotnet.microsoft.com/download/dotnet-framework/thank-you/net472-developer-pack-offline-installer) (required for IntelliSense when editing code scripts)
- [Python 3.10](https://www.python.org/downloads/release/python-31011/) (required for bootstrapping Python environments)
- [Git for Windows](https://gitforwindows.org/) (recommended for cloning and manipulating this repository)
- [Visual C++ Redistributable for Visual Studio 2012](https://www.microsoft.com/en-us/download/details.aspx?id=30679) (native dependency for OpenCV)
- [Spinnaker SDK 1.29.0.5](https://www.flir.co.uk/support/products/spinnaker-sdk/#Downloads) (device drivers for FLIR cameras)
  - On the FLIR website: `Download > archive > 1.29.0.5 > SpinnakerSDK_FULL_1.29.0.5_x64.exe`
- [CUDA 11.3](https://developer.nvidia.com/cuda-11.3.0-download-archive) (for SLEAP multi-animal tracking)
  - Select **Custom install** and check `CUDA > Development` and `CUDA > Runtime` ONLY (uncheck everything else)

### Inventory

A local inventory can be accessed by aeon members [here](https://docs.google.com/spreadsheets/d/1T7EVcioJGYADa492KawHQlV7ZcGx9It75jTjiwnZV0w/edit?gid=0#gid=0)

### Hardware Setup

The workflow is designed to work with three [FLIR Spinnaker Blackfly S cameras, BFS-U3-16S2M](https://www.flir.com/products/blackfly-s-usb3/?model=BFS-U3-16S2M-CS). The workflow itself configures the Blackfly S cameras. Each camera should be connected to the acquisition computer using USB 3.1. Cameras are assigned through their unique serial numbers, so the order of connection is not important.

[Harp](https://harp-tech.org/) devices are synchronized in a hub-and-spoke topology using a [ClockSynchronizer](https://github.com/harp-tech/device.clocksynchronizer) board. Cameras are triggered simultaneously using one of two independent PWM pulses generated by an [OutputExpander](https://github.com/harp-tech/harp_expander) board (the `VideoController`). Hirose 6-pin GPIO cables can be used to connect the trigger line to the cameras. 

A "patch" is controlled independently by an [OutputExpander](https://github.com/harp-tech/harp_expander) board (`Patch1`). This board monitors the wheel encoder and controls the [FED3](https://open-ephys.org/fed3/fed3>) [feeder module](). The patch is powered by USB to continuously charge the FED3 battery, with a digital line coming from the Expander board to trigger pellet delivery. Detection of whether a pellet has been delivered in the chute is done using a digital line from the collector of the photo-transistor built into the FED3 through a 1 kÎ© pull-up resistor.

A Radio Frequency Identity Reader (RFID) board is placed under the feeder patch and connected to the acquisition computer via USB 2.1. Such readers are utilised in Aeon experiments to confirm the identity of experimental subjects with subcutaneous identifying chips.
An ultrasound sensitive microphone is also connected to the acqusiiton computer via USB 2.1. <!-- Consider update with links to hardware -->

Automatic weighing of animals is performed using the [Ohaus Navigator NVT2201 Electronic Balance](https://us.ohaus.com/en-US/Products/Balances-Scales/Portable-Balances/Navigator/Electronic-Balance-NVT2201-AM) via its USB interface. The following setup procedure must be completed on the balance before it is connected to the system for the first time:

1. Rotate the transportation lock under the balance to the **unlocked** position.
2. Level the balance so the level indicator bubble on the top-right corner of the front panel is centered.
3. Connect the USB interface to the communication port under the balance and then to the computer.
4. Hold the **Tare** button until the display changes to `Menu`, then release the button. The display should now show `.C.A.L.`.
5. Press the `Print / No` button until the menu shows `U.S.b.`.
6. Press the `Zero / Yes` button to start USB interface configuration. Use the following settings:
   - **On-Off**: On
   - **Baud**: 9600
   - **Parity**: 8-none
   - **Handsh**: none
   - **End**: End
7. In the main menu, navigate to `Mode` and set:
   - **Stable**: Off
8. In the main menu, navigate to `P.r.i.n.t` and set:
   - **Stable**: Off
   - **A.Print**: Cont
   - **End**: End

All these devices are connected to the computer and configured, by default, at the following COM ports:

| COM Port | Device Name       |
|----------|-------------------|
| COM1     | ClockSynchronizer |
| COM2     | VideoController   |
| COM3     | Patch1            |
| COM4     | Nest              |
| COM5     | NestRfid1         |
| COM6     | Patch1Rfid        |

### Environment Setup

The `.bonsai` folder contains a snapshot of the runtime environment required to run the template on a minimal foraging arena. The `deploy.cmd` batch script is included in the top level of this repository to automate the download and configuration of this environment. Simply double-clicking or running this script from a terminal will launch the necessary PowerShell commands as long as an active internet connection is available. After completing this script, the `miniAeon.bonsai` workflow can be opened, edited, and run through the executable `Bonsai.exe`.

If the environment configuration becomes corrupted, you can revert and reinstall the `.bonsai` environment by re-running the `deploy.cmd` script.

### Useful links

- 
### Incoming Webhooks

**WIP**

### Data Transfer

**WIP**

## Citation Policy

If you use this software, please cite it as follows:

Sainsbury Wellcome Centre Foraging Behaviour Working Group. (2023). *Aeon: An open-source platform to study the neural basis of ethological behaviours over naturalistic timescales.* https://doi.org/10.5281/zenodo.8411157

[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.8411157.svg)](https://zenodo.org/doi/10.5281/zenodo.8411157)
